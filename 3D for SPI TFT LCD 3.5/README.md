![photo_5_2025-10-30_16-47-58](https://github.com/user-attachments/assets/1c017264-df0d-4507-81e6-20dd8b8f97ff)# Touchpad & Joystick 3D — Управление и псевдо-3D на SPI TFT LCD 3.5" с помощью микроконтроллера MIK32

Кратко: проект реализует масштабирование и вращение прямоугольника (тачпадом), псевдо‑3D отображение на экране и поворот 3D‑куба как с тачпада, так и с джойстика.
---

## Содержание

1. [Обзор](#обзор)
2. [Функциональность](#функциональность)
3. [Аппаратная часть](#аппаратная-часть)
4. [Программная архитектура](#программная-архитектура)
5. [Алгоритмы и реализация](#алгоритмы-и-реализация)

   * масштабирование (тачпад)
   * вращение (тачпад)
   * псевдо‑3D (проекция)
   * вращение куба (тачпад и джойстик)
6. [Как собрать и прошить](#как-собрать-и-прошить)
7. [Фотографии](#фотографии)

---

## Обзор

Цель проекта — получить удобный интерфейс управления графическим объектом (прямоугольник и куб) на микроконтроллере MIK32 с экраном и двумя входами управления:

* тачпад — для масштабирования и вращения прямоугольника; для куба тачпад даёт направление вращения;
* джойстик — обеспечивает физическое управление поворотом куба; реализованы фильтрация, мёртвая зона и возможность калибровки центра;
* псевдо‑3D — отрисовка куба с перспективой (проекция) и видимыми гранями.

Проект предназначен как демо для обучения и как модуль для интеграции в более крупные интерфейсы.

---

## Функциональность

* Масштабирование прямоугольника перемещением отдельных сторон.
* Вращение прямоугольника с помощью жеста вверх или вниз.
* Псевдо‑3D на экране: проекция 3D точек на 2D с управлением перспективой.
* Вращение 3D‑куба:

  * с тачпада — поворот пока пользователь держит жест/свайп; скорость зависит от величины жеста;
  * с джойстика — поворот пока пользователь держит джойстик, отпускает, и куб возвращается на место
* Фильтрация входных данных (скользящее среднее), мёртвая зона и автокалибровка центра.

---

## Аппаратная часть

Минимальный набор:

* MIK32 Амур от Микрон, на котором работает HAL и SPI
* Дисплей со встроенным тачпадом (SPI TFT LCD 3.5")
* Джойстик с кнопкой (SPI/ADC или модуль с цифровым интерфейсом)
* Провода, питание, отладчик

---

## Алгоритмы и реализация

### Масштабирование прямоугольника (тачпад)

Идея: перемещаем тачпадом одну из сторон, тем самым масштабируя прямоугольник

    if (!initialized) void draw_rectangle(const Rectangle *rect, uint16_t color)
    {
    if (!rect) return;
    H_line(rect->x, rect->y, rect->width, color);                  // верх
    H_line(rect->x, rect->y + rect->height, rect->width, color);   // низ
    V_line(rect->x, rect->y, rect->height, color);                 // левая
    V_line(rect->x + rect->width, rect->y, rect->height, color);   // правая
    }
---

### Вращение прямоугольника (тачпад)

Идея: в зависимости от координаты по Y тачпада, будет меняться угол поворота (Ymax = 320: 320/2 - 0 градусов поворота, 320 - 180 градусов против часовой, 0 - 180 градусов по часовой)

    int coord_x = transform(y, 2032, 100, 480, 0);
    //int coord_y = transform(y, 2032, 100, 480, 0);
    // Инициализация
    if (!initialized)
    {
        last_x = coord_x;
        initialized = 1;
    }
    draw_rotated_rect(rect, BG_COLOR);// Стираем старый прямоугольник
    int dx = coord_x - last_x; // Вычисляем изменение положения по X
    angle_deg += dx * 0.5f; //для плавности
    // Ограничим диапазон угла
    if (angle_deg > 180) angle_deg -= 360;
    if (angle_deg < -180) angle_deg += 360;

    rect->angle = angle_deg; // Обновляем угол и рисуем новый
    draw_rotated_rect(rect, RECT_COLOR);

    last_x = coord_x; // Обновляем последнюю координату
    }
---

### Псевдо‑3D (проекция)

Для псевдо‑3D используется простая перспективая проекция точки (x, y, z) в экранные координаты (X, Y):

    touch.last_x = coord_x;
    touch.last_y = coord_y;Vec3 cube[] = {
    {-1, -1, -1},
    { 1, -1, -1},
    { 1,  1, -1},
    {-1,  1, -1},
    {-1, -1,  1},
    { 1, -1,  1},
    { 1,  1,  1},
    {-1,  1,  1}
    };
    
    uint8_t edges[][2] = {
    {0,1},{1,2},{2,3},{3,0},
    {4,5},{5,6},{6,7},{7,4},
    {0,4},{1,5},{2,6},{3,7}
    }; 
    
    Vec2 project(Vec3 v)//проектирование куба{
    int scale = 150; //размер куба
    int px = (v.x / (v.z + 3)) * scale + 230; //начальный х
    int py = (v.y / (v.z + 3)) * scale + 480 / 3; //начальный у
    Vec2 res = {px, py};
    return res;
    }

---

### Вращение куба (тачпад )

Тачпад: при движении пальца вычисляем dx, dy — и переводим в угловые скорости:

    if (!active) {
        touch.last_x = coord_x;
        touch.last_y = coord_y;
        last_coord_x = coord_x;
        last_coord_y = coord_y;
        active = 1;
        cube_update = 0;
        return;
    } 
    // если палец стоит на месте — не вращаем
    if (abs(coord_x - last_coord_x) < 3 && abs(coord_y - last_coord_y) < 3) {
        cube_update = 0; // не нужно обновление
        return;
    }
    // вычисляем изменение
    int dx = coord_x - touch.last_x;
    int dy = coord_y - touch.last_y;
    // вращаем (чем меньше множители — тем плавнее)
    angle_y += dx * 0.005f;
    angle_x += dy * 0.005f;

    touch.last_x = coord_x;
    touch.last_y = coord_y;
    last_coord_x = coord_x;
    last_coord_y = coord_y;

    cube_update = 1; // куб нужно обновить
  }


## Как собрать и прошить

Вся информация по настройке и прошивке преставленна на сайте Микрона: https://docs.mikron.ru/wiki/index.html


## Фотографии

![Тачпад масштабирование прямоугольника](![photo_5_2025-10-30_16-47-58](https://github.com/user-attachments/assets/52012271-95f3-45ca-b974-6bc1b0a9e768))
*Масштабирование прямоугольника.*

![Тачпад вращение прямоугольника](![photo_4_2025-10-30_16-47-58](https://github.com/user-attachments/assets/f4e6012b-28b2-434a-913d-090eead5be53))
*Вращение прямоугольника.*

![Псевдо-3D и куб](![photo_3_2025-10-30_16-47-58](https://github.com/user-attachments/assets/afc36ec9-241e-45d9-be69-47e9f76d79f5))
*Псевдо‑3D — куб в перспективе.*

![Джойстик вращение куба](![photo_2_2025-10-30_16-47-58](https://github.com/user-attachments/assets/eaad91bb-f469-4123-ab8e-c40896147b29))
*Управление кубом с помощью джойстика.* 

![Тачпад вращение куба](![photo_1_2025-10-30_16-47-58](https://github.com/user-attachments/assets/fae06a9e-94fe-4297-a9cc-294768efa4f7))
*Управление кубом с помощью джойстика.* 



